<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Informe Web - Ventas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ===== ESTILOS BASE ===== */
    html, body {
        overflow-x: hidden;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #f0f2f5;
        padding: 1rem;
        margin: 0;
    }
    
    .app-container {
        max-width: 1400px;
        margin: 0 auto;
        background-color: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
        border-radius: 1.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 8px 16px -4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: relative;
    }
    
    /* ===== ESTILOS DE CARGA ===== */
    .loading-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(255,255,255,0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        transition: opacity 0.3s;
    }
    
    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .spinner {
        width: 56px; height: 56px;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* ===== CABECERA DE CONTROLES ===== */
    .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .control-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .control-button {
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        background-color: white;
        color: #4b5563;
        border: 1px solid #d1d5db;
        border-radius: 9999px;
        font-size: 0.875rem; font-weight: 600;
        cursor: pointer; transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .control-button:hover {
        background-color: #f9fafb;
        transform: translateY(-1px);
    }
    
    .control-button.primary {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
    
    .control-button.primary:hover {
        background-color: #2563eb;
    }
    
    /* ===== GRUPO DE BÚSQUEDA Y FILTROS ===== */
    .search-filter-group {
        display: flex; align-items: center;
        border: 1px solid #d1d5db; border-radius: 9999px;
        background-color: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease-in-out;
    }
    
    .search-filter-group:focus-within {
        border-color: #6b7280;
        box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.2);
    }
    
    .search-filter-group .search-input {
        border: none; background: transparent; outline: none;
        padding: 0.75rem; font-size: 0.875rem;
        width: 180px;
    }
    
    .search-filter-group .separator {
        width: 1px; height: 24px; background-color: #e5e7eb;
    }
    
    /* ===== TABLA DE DATOS ===== */
    .table-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 1rem 2.5rem;
        flex-wrap: wrap; gap: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .nav-tabs {
        display: flex; background-color: #f3f4f6;
        padding: 0.25rem; border-radius: 0.75rem;
        overflow-x: auto;
    }
    
    .tab {
        padding: 0.5rem 1rem; cursor: pointer; border-radius: 0.5rem;
        font-size: 0.875rem; font-weight: 600;
        color: #6b7280; transition: all 0.2s;
        white-space: nowrap;
    }
    
    .tab.active {
        background-color: white;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        color: #1f2937;
    }
    
    .table-wrapper { 
        padding: 1rem 2.5rem 2.5rem; 
        overflow-x: auto; 
    }
    
    .data-table { 
        width: 100%; 
        border-collapse: separate; 
        border-spacing: 0 1rem; 
    }
    
    .data-table th, .data-table td { 
        padding: 1.5rem 1.25rem; 
        text-align: left; 
        vertical-align: middle; 
    }
    
    .data-table th { 
        font-size: 0.8rem; 
        font-weight: 700; 
        color: #6b7280; 
        text-transform: uppercase; 
    }
    
    .data-table th:not(:nth-child(4)):not(:nth-child(5)),
    .data-table td:not(:nth-child(4)):not(:nth-child(5)) {
        text-align: center;
    }
    
    .data-table tr {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        position: relative;
    }
    
    .data-table tr:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.07); 
    }
    
    .data-table td { 
        background-color: white; 
    }
    
    .data-table tr td:first-child { 
        border-top-left-radius: 0.75rem; 
        border-bottom-left-radius: 0.75rem; 
    }
    
    .data-table tr td:last-child { 
        border-top-right-radius: 0.75rem; 
        border-bottom-right-radius: 0.75rem; 
    }
    
    /* ===== ELEMENTOS DE LA TABLA ===== */
    .logo-container {
        width: 44px; height: 44px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-size: 1.1rem; font-weight: 700; color: white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        flex-shrink: 0; margin: 0 auto;
    }
    
    .status-badge {
        display: inline-flex; align-items: center; gap: 0.5rem;
        padding: 0.4rem 1.2rem; border-radius: 9999px;
        font-size: 0.75rem; font-weight: 600;
    }
    
    .status-badge.despacho { background-color: #e9d5ff; color: #9333ea; }
    .status-badge.pendiente { background-color: #fffbe6; color: #d97706; }
    .status-badge.pre-ingreso { background-color: #e0f2fe; color: #0284c7; }
    .status-badge.rechazado { background-color: #fee2e2; color: #dc2626; }
    .status-badge.finalizado { background-color: #dcfce7; color: #16a34a; }
    
    .client-info span {
        display: flex; align-items: center; gap: 0.5rem;
        font-size: 0.875rem; color: #4b5563;
    }
    
    .client-info span.name { 
        font-weight: 600; 
        color: #1f2937; 
        font-size: 0.9rem; 
    }
    
    /* ----------------------
   DROPDOWN: action-dropdown-menu
   ---------------------- */

/* Contenedor del menú desplegable */
.action-dropdown-menu {
    position: absolute;                  /* Absoluto respecto al botón */
    right: 0;                            /* Inicialmente alineado a la derecha */
    top: calc(100% + 0.5rem);            /* Debajo del botón */
    width: 220px;                         /* Ancho fijo inicial */
    background-color: white;             /* Fondo blanco */
    border-radius: 0.75rem;              /* Bordes redondeados */
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); /* Sombra */
    z-index: 40;                          /* Encima de otros elementos */
    border: 1px solid #f3f4f6;          /* Borde */
    transition: all 0.2s ease-in-out;    /* Animación suave */
    transform-origin: top right;         /* Escala desde la esquina superior derecha */
    opacity: 0;                          /* Invisible inicialmente */
    visibility: hidden;                  /* Oculto inicialmente */
    transform: scale(0.95);              /* Escala inicial menor */
}

/* Estado abierto del menú */
.action-dropdown-menu.is-open { 
    opacity: 1; 
    visibility: visible; 
    transform: scale(1); 
}

/* Botón que activa el dropdown */
.action-dropdown-button {
    display: block; 
    width: 100%; 
    text-align: left;
    padding: 0.75rem 1.25rem; 
    font-size: 0.875rem;
    font-weight: 600; 
    color: #4b5563;
    background: none; 
    border: none; 
    cursor: pointer;
}

/* Efecto hover del botón */
.action-dropdown-button:hover { 
    background-color: #f3f4f6; 
}

/* ----------------------
   INSTRUCCIONES PARA CONTROL POR PORCENTAJE
   ---------------------- */

/* Comentarios:
1. Este CSS pertenece al desplegable "action-dropdown-menu".
2. Para mover horizontalmente: actualizar 'left' en porcentaje via JS.
   Ejemplo: menu.style.left = leftPercent + '%';
3. Para mover verticalmente: actualizar 'top' en porcentaje.
   Ejemplo: menu.style.top = topPercent + '%';
4. Para cambiar ancho: menu.style.width = widthPercent + 'px';
5. Para cambiar alto: menu.style.height = heightPercent + 'px' o 'auto';
6. Mantener clase 'is-open' para animación y visibilidad.
7. NO cambiar colores, sombras, bordes ni estilos originales.
*/

    
    /* ===== BOTONES DE ACCIÓN EN TABLA ===== */
    .action-btn-table {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2.5rem;
        height: 2.5rem;
        background-color: white;
        color: #6b7280;
        border: 1px solid #d1d5db;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .action-btn-table:hover {
        background-color: #f0f2f5;
        transform: scale(1.1);
        color: #3b82f6;
    }
    
    .action-btn-table:active {
        background-color: #3b82f6;
        color: white;
        transform: scale(1);
        border-color: #3b82f6;
    }

   
    /* ===== SELECT PERSONALIZADO PARA MARCAS ===== */
    .custom-select-trigger {
        display: flex; 
        align-items: center; 
        justify-content: space-between;
        padding: 0.75rem 1rem 0.75rem 0.75rem;
        font-size: 0.875rem; 
        color: #4b5563;
        background-color: transparent; 
        cursor: pointer;
        border: none; 
        font-weight: 500;
    }
    
    .custom-select-trigger .trigger-content {
        display: flex; 
        align-items: center; 
        gap: 0.5rem;
    }
    
    .custom-select-options {
        position: absolute; 
        top: calc(100% + 1rem); 
        left: 0;
        background-color: white; 
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 50; 
        border: 1px solid #f3f4f6;
        overflow: auto; 
        max-height: 250px;
        opacity: 0; 
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease-in-out;
        min-width: 220px;
    }
    
    .custom-select-options.is-open { 
        opacity: 1; 
        visibility: visible; 
        transform: translateY(0); 
    }
    
    .custom-select-option {
        padding: 0.75rem 1.25rem; 
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.875rem; 
        font-weight: 500;
    }
    
    .custom-select-option:hover { 
        background-color: #f3f4f6; 
    }
    
    .custom-select-option.selected { 
        font-weight: 600; 
        color: #1f2937; 
    }
    
   /* ===== MODALES ===== */

/* Contenedor del modal */
.modal {
    position: fixed; /* Fijo sobre la ventana, necesario para mover con top/left */
    top: 0; /* Posición vertical inicial (puede controlarse con porcentaje) */
    left: 0; /* Posición horizontal inicial (puede controlarse con porcentaje) */
    width: 100%; /* Ancho completo de la pantalla */
    height: 100%; /* Alto completo de la pantalla */
    background-color: rgba(0, 0, 0, 0.5); /* Fondo semitransparente */
    display: none; /* Inicialmente oculto, mostrar con clase .is-open */
    align-items: center; /* Centrado vertical del contenido */
    justify-content: center; /* Centrado horizontal del contenido */
    z-index: 1000; /* Encima de otros elementos */
    backdrop-filter: blur(5px); /* Efecto desenfoque detrás del modal */
    padding: 1rem; /* Espaciado interno */
}

/* Mostrar modal */
.modal.is-open { 
    display: flex; /* Cambia display a flex para que se vea */
}

/* Contenido interno del modal */
.modal-content {
    background-color: #ffffff; /* Fondo blanco */
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); /* Sombra alrededor */
    max-width: 500px; /* Ancho máximo */
    width: 90%; /* Ancho relativo al contenedor */
    height: auto; /* Altura automática según contenido */
    max-height: 90vh; /* Máximo alto según la ventana */
    border-radius: 1.5rem; /* Bordes redondeados visibles */
    transform: scale(0.95); /* Escala inicial, se puede animar */
    opacity: 0; /* Invisible inicialmente */
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; /* Animación suave */
    border: 1px solid #e5e7eb; /* Borde */
    display: flex; /* Flex para organizar contenido interno */
    flex-direction: column; /* Contenido en columna */
    margin: auto; /* Centrado automático */
    text-align: left; /* Alineación del texto */
    overflow-y: auto; /* Scroll vertical si el contenido excede */
    overflow-x: hidden; /* Oculta scroll horizontal */
}

/* Mostrar contenido del modal */
.modal.is-open .modal-content {
    transform: scale(1); /* Escala final al mostrar */
    opacity: 1; /* Visible al abrir */
}

/* Header del modal */
.modal-header {
    display: flex; /* Flex para organizar elementos */
    justify-content: space-between; /* Separar título y botón cerrar */
    align-items: center; /* Centrado vertical */
    padding: 1rem 1.5rem; /* Espaciado interno */
    border-bottom: 1px solid #e5e7eb; /* Separador inferior */
    flex-shrink: 0; /* No encoger al ajustar tamaño */
    border-top-left-radius: 1.5rem; /* Borde redondeado superior izquierdo */
    border-top-right-radius: 1.5rem; /* Borde redondeado superior derecho */
}

/* Título del modal */
.modal-header h3 { 
    font-size: 1.25rem; /* Tamaño de fuente */
    font-weight: 700; /* Negrita */
    margin: 0; /* Sin margen extra */
}

/* Botón de cerrar modal */
.close-btn { 
    background: none; /* Sin fondo */
    border: none; /* Sin borde */
    cursor: pointer; /* Cursor pointer al pasar sobre él */
    font-size: 2rem; /* Tamaño del icono */
    color: #9ca3af; /* Color gris */
    line-height: 1; /* Altura de línea */
}

/* Body del modal */
.modal-body { 
    padding: 1.5rem 2rem 2rem; /* Espaciado interno */
    border-bottom-left-radius: 1.5rem; /* Borde redondeado inferior izquierdo */
    border-bottom-right-radius: 1.5rem; /* Borde redondeado inferior derecho */
}

/* Item de información dentro del body */
.modal-body .info-item {
    display: flex; /* Flex para separar texto e íconos */
    justify-content: space-between; /* Separación */
    align-items: center; /* Centrado vertical */
    padding: 0.75rem 0; /* Espaciado vertical */
    border-bottom: 1px solid #f3f4f6; /* Separador entre items */
    text-align: left; /* Texto alineado a la izquierda */
}

/* Último item sin borde inferior */
.modal-body .info-item:last-child { 
    border-bottom: none; 
}

/* Texto destacado dentro de item */
.modal-body .info-item strong {
    font-weight: 600; /* Negrita */
    color: #4b5563; /* Color gris oscuro */
    display: flex; /* Flex para alinear íconos o elementos */
    align-items: center; /* Centrado vertical */
    gap: 0.75rem; /* Espacio entre elementos */
}

/* Contenido iframe dentro del modal */
.iframe-modal-content {
    height: 90vh; /* Alto del iframe */
    padding: 0; /* Sin padding */
    gap: 0; /* Sin espacio entre hijos */
    overflow: hidden; /* Ocultar overflow */
    text-align: left; /* Alineación izquierda */
    border-radius: 1.5rem; /* Bordes redondeados para el iframe */
}

/* Contenedor del iframe */
.iframe-container { 
    flex-grow: 1; /* Ocupa todo el espacio disponible */
    overflow: hidden; /* Ocultar overflow */
    border-radius: 1.5rem; /* Bordes redondeados visibles */
}

/* Estilo del iframe */
.iframe-container iframe { 
    width: 100%; /* Ancho completo */
    height: 100%; /* Alto completo */
    border: 0; /* Sin borde */
    border-radius: 1.5rem; /* Bordes redondeados visibles */
}

/* ======================
   INSTRUCCIONES PARA CONTROL POR PORCENTAJE
   ====================== */

/* Comentarios:
- Este CSS pertenece a los modales "modal / modal-content".
- Para mover el modal horizontalmente: modal.style.left = leftPercent + '%';
- Para mover el modal verticalmente: modal.style.top = topPercent + '%';
- Para cambiar ancho del modal: modalContent.style.width = widthPercent + '%';
- Para cambiar alto del modal: modalContent.style.height = heightPercent + 'px' o 'auto';
- Mantener todas las propiedades de color, borde y sombra para no perder el diseño.
- Mantener la clase .is-open para animación y visibilidad.
- Todos los bordes ahora están redondeados correctamente.
*/

    
    /* ===== BARRAS DE DESPLAZAMIENTO ===== */
    .modal-content::-webkit-scrollbar,
    #notificationsDropdown::-webkit-scrollbar,
    .table-wrapper::-webkit-scrollbar,
    .nav-tabs::-webkit-scrollbar {
        width: 4px;
        height: 4px;
    }

    .modal-content::-webkit-scrollbar-track,
    #notificationsDropdown::-webkit-scrollbar-track,
    .table-wrapper::-webkit-scrollbar-track,
    .nav-tabs::-webkit-scrollbar-track {
        background: transparent;
    }

    .modal-content::-webkit-scrollbar-thumb,
    #notificationsDropdown::-webkit-scrollbar-thumb,
    .table-wrapper::-webkit-scrollbar-thumb,
    .nav-tabs::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.1);
        border-radius: 10px;
    }

    .modal-content:hover::-webkit-scrollbar-thumb,
    #notificationsDropdown:hover::-webkit-scrollbar-thumb,
    .table-wrapper:hover::-webkit-scrollbar-thumb,
    .nav-tabs:hover::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
    }

    .modal-content,
    #notificationsDropdown,
    .table-wrapper,
    .nav-tabs {
        scrollbar-width: thin;
        scrollbar-color: rgba(0,0,0,0.2) transparent;
    }
    
    /* ===== CHAT Y BOTÓN FLOTANTE ===== */
    .fab {
        position: fixed; 
        bottom: 2rem; 
        right: 2rem;
        width: 4rem; 
        height: 4rem; 
        background-color: #25D366;
        color: white; 
        border-radius: 50%; 
        border: none;
        display: flex; 
        align-items: center; 
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer; 
        z-index: 1010;
        transition: transform 0.2s ease-in-out;
    }
    
    .fab:hover { 
        transform: scale(1.1); 
    }
    
    .chat-widget {
        position: fixed; 
        bottom: 7rem; 
        right: 2rem;
        width: 360px; 
        background-color: white;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        overflow: hidden; 
        display: flex; 
        flex-direction: column;
        z-index: 1020;
        transition: all 0.3s ease-in-out;
        opacity: 0; 
        visibility: hidden; 
        transform: translateY(20px);
    }
    
    .chat-widget.is-open { 
        opacity: 1; 
        visibility: visible; 
        transform: translateY(0); 
    }
    
    .chat-header {
        background-color: #128C7E; 
        color: white; 
        padding: 1rem;
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        font-weight: 600;
    }
    
    .chat-body { 
        padding: 1rem; 
        flex-grow: 1; 
    }
    
    #chat-options { 
        display: flex; 
        flex-direction: column; 
        gap: 1rem; 
    }
    
    #chat-options button {
        width: 100%; 
        padding: 0.75rem; 
        border-radius: 0.5rem;
        border: 1px solid transparent; 
        font-weight: 600; 
        cursor: pointer;
    }
    
    #whatsapp-btn { 
        background-color: #25D366; 
        color: white; 
    }
    
    #factibilidad-btn { 
        background-color: #3b82f6; 
        color: white; 
    }
    
    #assistant-btn { 
        background-color: #f0f2f5; 
        color: #1f2937; 
    }
    
    /* ===== NOTIFICACIONES ===== */
    .notification-badge {
        position: absolute; 
        top: -2px; 
        right: -2px;
        width: 8px; 
        height: 8px; 
        background-color: red;
        border-radius: 50%; 
        border: 2px solid white;
    }
    
    #notificationsDropdown { 
        width: 350px; 
        max-height: 400px; 
        overflow-y: auto; 
    }
    
    .notification-item {
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .notification-item:last-child { 
        border-bottom: none; 
    }
    
    .notification-item p { 
        margin: 0; 
        color: #4b5563; 
        font-size: 0.875rem; 
    }
    
    .notification-item span { 
        font-size: 0.75rem; 
        color: #9ca3af; 
    }
    
    .notification-item.unread p { 
        font-weight: 600; 
        color: #1f2937; 
    }
    
    .relative { 
        position: relative; 
    }
    
    /* ===== ESTILOS PARA MÓVILES ===== */
    @media (max-width: 768px) {
        body { 
            padding: 0; 
            font-size: 14px; 
        }
        
        .app-container { 
            border-radius: 0; 
            box-shadow: none; 
            border: none; 
            background-color: #f0f2f5; 
        }
        
        .controls-header { 
            flex-direction: column; 
            align-items: stretch; 
            padding: 1rem;
            gap: 1rem;
        }
        
        .control-group { 
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .search-filter-group { 
            width: 100%;
        }
        
        .control-group:last-of-type {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        #commercialConditionsContainer { 
            width: 100%;
        }
        
        #btn-nueva-venta { 
            width: 100%;
            order: 99;
        }
        
        #btn-descargar-excel { 
            width: calc(50% - 0.4rem);
            flex-grow: 0;
        }
        
        #notificationsContainer { 
            width: calc(25% - 0.4rem);
            flex-grow: 0;
        }
        
        #moreActionsContainer { 
            width: calc(25% - 0.4rem);
            flex-grow: 0;
        }
        
        #btn-descargar-excel, #notificationsTrigger, #moreActionsTrigger {
            width: auto;
            padding: 0.75rem;
            justify-content: center;
        }
        
        #btn-descargar-excel .button-text, 
        #moreActionsTrigger .button-text,
        #notificationsTrigger .button-text {
            display: none;
        }
        
        #btn-descargar-excel > svg, 
        #notificationsTrigger > div > svg, 
        #moreActionsTrigger > svg {
            margin: 0 auto;
        }
        
        .table-header { 
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table-wrapper { 
            overflow-x: auto; 
            padding: 0 1rem 1rem 1rem;
        }
        
        .data-table {
            min-width: 800px;
        }
        
        .data-table th, .data-table td {
            white-space: nowrap;
        }
        
        .fab { 
            bottom: 1.5rem; 
            right: 1.5rem; 
        }
        
        .chat-widget { 
            left: 1rem;
            right: 1rem;
            transform: none;
            bottom: 6rem;
            width: auto;
            max-width: 360px;
            margin: 0 auto;
        }
        
       /* ----------------------
   ESTILOS ORIGINALES DEL MODAL
   ---------------------- */

/* Contenedor general del modal */
.modal {
    display: flex;               /* Flex para centrar contenido */
    align-items: center;         /* Centra verticalmente */
    justify-content: center;     /* Centra horizontalmente */
    padding: 1rem;               /* Espacio interno */
    position: fixed;             /* Fijo sobre la ventana */
    top: 50%;                    /* Posición inicial vertical */
    left: 50%;                   /* Posición inicial horizontal */
    transform: translate(-50%, -50%); /* Centrado exacto */
    width: 90%;                 /* Ocupa toda la pantalla */
    height: 90%;                /* Ocupa toda la pantalla */
    z-index: 999;                /* Encima de todo */
    background: rgba(0,0,0,0.3); /* Fondo semitransparente */
}

/* Contenido interno del modal */
.modal-content {
    width: 95% !important;       /* Ancho máximo del contenido */
    max-width: 95% !important;   /* No se expanda más allá */
    margin: 0 auto;              /* Centrado horizontal */
    position: absolute;          /* Posición absoluta dentro del modal */
}

/* Modal específico con ID iframeModal */
.modal#iframeModal {
    padding: 0;                  /* Sin padding extra */
}

/* Contenido del modal iframeModal */
.modal#iframeModal .modal-content {
    max-width: 100%;             /* Máximo ancho 100% */
    width: 100%;                 /* Ancho completo */
    height: 100%;                /* Altura completa */
    max-height: 100vh;           /* No excede altura de ventana */
    border-radius: 1.5;            /* Esquinas cuadradas */
}

/* ----------------------
   AQUI PUEDES INTEGRAR EL PANEL DIDÁCTICO
   ---------------------- */

/* Comentario:
   1. Crear un div flotante en la esquina, por ejemplo:
      <div class="control-panel">...</div>
   2. Dentro poner dos sliders <input type="range">:
        - Uno para posición horizontal (%)
        - Otro para posición vertical (%)
   3. Un botón para mostrar/ocultar el modal
   4. Con JavaScript, actualizar:
        modalContent.style.left = left + '%';
        modalContent.style.top = top + '%';
      Esto moverá el modal manteniendo tu CSS original.
   5. Puedes mantener el transform: translate(-50%, -50%) para centrar siempre.
*/

/* Ejemplo de estilos mínimos para el panel (puedes ajustar) */
.control-panel {
    position: fixed;       /* Flotante sobre la pantalla */
    top: 10px;             /* Desde arriba */
    left: 10px;            /* Desde izquierda */
    background: #fff;      /* Fondo blanco */
    padding: 15px;         /* Espaciado interno */
    border-radius: 8px;    /* Bordes redondeados */
    box-shadow: 0 0 10px rgba(0,0,0,0.2); /* Sombra */
    z-index: 1000;         /* Encima del modal */
}

/* Los sliders dentro del panel se pueden estilizar así */
.control-panel input[type="range"] {
    width: 100%;           /* Ocupa todo el ancho del panel */
}

        
        #notificationsDropdown,
        #moreActionsDropdown {
            right: 0.5rem !important;
            left: auto !important;
            width: 280px !important;
        }
        
        #commercialConditionsDropdown,
        #brandFilterOptions {
            left: 0.5rem !important;
            right: auto !important;
            width: calc(100vw - 1rem) !important;
            max-width: 320px;
        }
    }
  </style>
</head>
<body>

<div class="app-container">
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 600; color: #4b5563;">Cargando datos...</p>
    </div>
    
    <div class="controls-header">
        <div class="control-group">
            <div class="search-filter-group">
                <svg style="color: #9ca3af; margin-left: 1rem; width: 1.25rem; height: 1.25rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <input type="text" id="searchInput" placeholder="Buscar por cliente..." class="search-input">
                <div class="separator"></div>
                <div id="brandFilterContainer" class="relative"></div>
            </div>
        </div>
        
        <div class="control-group">
            <div class="relative dropdown-container" id="commercialConditionsContainer">
                <button id="commercialConditionsTrigger" class="control-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span class="button-text">Condic. Comerciales</span>
                    <svg style="width: 1rem; height: 1rem; margin-left: 0.25rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg>
                </button>
                <div id="commercialConditionsDropdown" class="action-dropdown-menu"></div>
            </div>
            
            <button class="control-button" id="btn-descargar-excel">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <span class="button-text">Descargar Excel</span>
            </button>
            
            <div class="relative dropdown-container" id="notificationsContainer">
                <button id="notificationsTrigger" class="control-button">
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <div id="notification-badge" class="notification-badge" style="display: none;"></div>
                    </div>
                </button>
                <div id="notificationsDropdown" class="action-dropdown-menu"></div>
            </div>
            
            <div class="relative dropdown-container" id="moreActionsContainer">
                <button id="moreActionsTrigger" class="control-button">
                    <span class="button-text">Más</span>
                    <svg style="width: 1rem; height: 1rem; margin-left: 0.25rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg>
                </button>
                <div id="moreActionsDropdown" class="action-dropdown-menu"></div>
            </div>
            
            <button class="control-button primary" id="btn-nueva-venta">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Ingresar Nueva Venta
            </button>
        </div>
    </div>
    
    <div class="table-wrapper">
        <div class="table-header">
            <div class="nav-tabs" id="navTabs"></div>
            <div class="last-updated" id="last-updated"></div>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Marca</th>
                    <th>ID Venta</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Vendedor</th>
                    <th>Estado</th>
                    <th>Productos</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- ===== MODAL DE DETALLES ===== -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Detalles de la Venta</h3>
            <button class="close-btn" onclick="window.closeModal('detailsModal')">&times;</button>
        </div>
        <div id="modal-body" class="modal-body">
            <div style="display:flex; justify-content:center; padding-bottom: 1rem;">
                <img id="modal-vendedor-img" src="https://placehold.co/100x100/EFEFEF/333333?text=?" style="width: 6rem; height: 6rem; border-radius: 50%; border: 4px solid #f3f4f6; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            </div>
            <h4 id="modal-vendedor-nombre" style="font-size: 1.25rem; font-weight: 600; margin: 0 0 1rem 0; text-align: center;"></h4>
            
            <div class="info-item">
                <strong>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#4b5563;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    Cliente
                </strong> 
                <span id="modal-cliente-nombre"></span>
            </div>
            <div class="info-item">
                <strong>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#4b5563;"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="6" y1="12" x2="10" y2="12"></line></svg>
                    RUT
                </strong> 
                <span id="modal-cliente-rut"></span>
            </div>
            <div class="info-item">
                <strong>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#4b5563;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-7.01-7.01A19.79 19.79 0 0 1 2.05 4.11a2 2 0 0 1 1.72-2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    Teléfono
                </strong> 
                <span id="modal-cliente-tel"></span>
            </div>
            <div class="info-item">
                <strong>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#4b5563;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    Comuna
                </strong> 
                <span id="modal-cliente-comuna"></span>
            </div>
        </div>
    </div>
</div>

<!-- ===== MODAL DE IFRAME ===== -->
<div id="iframeModal" class="modal">
    <div class="modal-content iframe-modal-content">
        <div class="modal-header">
            <h3 id="iframe-modal-title"></h3>
            <button class="close-btn" onclick="window.closeModal('iframeModal')">&times;</button>
        </div>
        <div class="iframe-container">
            <iframe id="modal-iframe-content" src="about:blank"></iframe>
        </div>
    </div>
</div>

<!-- ===== BOTÓN FLOTANTE ===== -->
<button id="fab" class="fab">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
</button>

<!-- ===== WIDGET DE CHAT ===== -->
<div id="chat-widget" class="chat-widget">
    <div class="chat-header">
        <span id="chat-title">Soporte</span>
        <button id="close-chat" class="close-btn" style="color: white; font-size: 1.5rem;">&times;</button>
    </div>
    <div class="chat-body">
        <div id="chat-options">
            <p style="text-align: center; font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">¿Cómo podemos ayudarte?</p>
            <button id="whatsapp-btn">Contactar por WhatsApp</button>
            <button id="factibilidad-btn">Factibilidad</button>
            <button id="assistant-btn">Asistente</button>
        </div>
    </div>
</div>

<script>
    // ===== CONFIGURACIÓN GLOBAL =====
    // ZONA DE EDICIÓN: Aquí puedes cambiar las URLs y opciones de menú
    
    // URL de la hoja de Google Sheets con los datos de ventas
    const urlVentas = "https://docs.google.com/spreadsheets/d/1Jsrqu5GwB8fTaetBULmi4txQI2FPLEQUyLZbJ7OR5PQ/gviz/tq?tqx=out:json&sheet=Ventas";
    
    // URL de la hoja de Google Sheets con las notificaciones
    const urlNotificaciones = "https://docs.google.com/spreadsheets/d/1_s_Lq-QBC8-0k-2S42-ASB01iUQ_A8-f-q_L-2jJ2zk/gviz/tq?tqx=out:json&sheet=Notificaciones";
    
    // Opciones del menú "Condiciones Comerciales"
    const opcionesMenuCondiciones = [
        { nombre: 'Políticas de Despacho', url: 'https://es.wikipedia.org/wiki/Log%C3%ADstica' },
        { nombre: 'Términos de Servicio', url: 'https://es.wikipedia.org/wiki/T%C3%A9rminos_de_servicio' },
        { nombre: 'Manual de Producto', url: 'https://es.wikipedia.org/wiki/Manual_de_usuario' },
        { nombre: 'Guía de Estilo', url: 'https://es.wikipedia.org/wiki/Manual_de_estilo' },
        { nombre: 'Protocolos de Atención', url: 'https://es.wikipedia.org/wiki/Servicio_de_atenci%C3%B3n_al_cliente' }
    ];
    
    // Opciones del menú "Más"
    const opcionesMenuMas = [
        { nombre: 'Reporte Avanzado', url: 'https://es.wikipedia.org/wiki/Business_intelligence' },
        { nombre: 'Metas de Venta', url: 'https://es.wikipedia.org/wiki/Venta' },
        { nombre: 'Capacitaciones', url: 'https://es.wikipedia.org/wiki/Capacitaci%C3%B3n' },
        { nombre: 'Herramientas', url: 'https://es.wikipedia.org/wiki/Herramienta' }
    ];
    
    // URL para nueva venta
    const urlNuevaVenta = 'https://script.google.com/macros/s/AKfycbx5pVBkIII1wA-toDC5sryro4C52U3nbjloflGMvzYF6fSWenA09OOBJ7hf8zpAHgz-/exec';
    
    // ===== VARIABLES GLOBALES =====
    let allSalesData = [];
    let allNotificationsData = [];
    let currentViewData = [];
    let filtroEstadoActual = '';
    let filtroMarcaActual = 'all';
    
    // ===== INICIALIZACIÓN DE LA APLICACIÓN =====
    document.addEventListener('DOMContentLoaded', () => {
        // CORRECCIÓN CRÍTICA: Forzar cierre de TODOS los modales al cargar
        const todosLosModales = document.querySelectorAll('.modal');
        todosLosModales.forEach(modal => {
            modal.classList.remove('is-open');
            modal.style.display = 'none';
        });
        
        // Cerrar también el chat y dropdowns
        const chatWidget = document.getElementById('chat-widget');
        if (chatWidget) chatWidget.classList.remove('is-open');
        
        const dropdowns = document.querySelectorAll('.action-dropdown-menu, .custom-select-options');
        dropdowns.forEach(dd => dd.classList.remove('is-open'));

        aplicarEstilosMovil();
        cargarDatosVentas();
        inicializarNotificaciones();
        inicializarDropdowns();
        inicializarChat();
        
        // Event listeners para botones principales
        document.getElementById('btn-descargar-excel').addEventListener('click', exportToExcel);
        document.getElementById('btn-nueva-venta').addEventListener('click', () => window.openIframeModal(urlNuevaVenta, 'Ingresar Nueva Venta'));
        
        // Cerrar modales al hacer clic fuera de ellos
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                window.closeModal(e.target.id);
            }
        });
    });
    
    // ===== CONFIGURACIÓN DE ESTILOS MÓVIL =====
    function aplicarEstilosMovil() {
        const configDisenoMovil = {
            paddingCabecera: '1rem',
            espacioEntreBotones: '0.75rem',
            paddingModales: '1rem'
        };
        
        const { paddingCabecera, espacioEntreBotones, paddingModales } = configDisenoMovil;
        
        const css = `
            @media (max-width: 768px) {
                .controls-header {
                    padding: ${paddingCabecera};
                    gap: ${espacioEntreBotones};
                }
                .control-group {
                    gap: ${espacioEntreBotones};
                }
                .modal {
                    padding: ${paddingModales};
                }
            }
        `;
        
        const styleElement = document.createElement('style');
        styleElement.innerHTML = css;
        document.head.appendChild(styleElement);
    }
    
    // ===== CARGA Y PROCESAMIENTO DE DATOS =====
    async function cargarDatosVentas() {
        document.getElementById('loading-overlay').classList.remove('hidden');
        
        try {
            const res = await fetch(urlVentas);
            const texto = await res.text();
            const json = parseGoogleSheetJSON(texto);

            // CORRECCIÓN: Verificar que 'rows' existe antes de mapear
            if (json.table && json.table.rows && json.table.rows.length > 0) {
                allSalesData = json.table.rows.map(f => f.c.map(c => c ? c.v : ''));
                currentViewData = [...allSalesData];
            } else {
                // Si no hay filas, inicializar como vacío para que no se rompa
                allSalesData = [];
                currentViewData = [];
            }
            
            renderTable(currentViewData);
            setupFilters();
            updateLastUpdatedTime();

        } catch (error) {
            console.error("Error al cargar los datos de ventas:", error);
            document.querySelector('.data-table tbody').innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem;">Error al cargar los datos.</td></tr>`;
        } finally {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
    }
    
    // ===== RENDERIZADO DE LA TABLA =====
    function renderTable(data) {
        const tableBody = document.querySelector('.data-table tbody');
        tableBody.innerHTML = '';
        
        if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem; background-color: transparent;">No se encontraron ventas.</td></tr>`;
            return;
        }
        
        data.forEach((row, index) => {
            const [id, fecha, hora, marca, rut, nombre, tel, comuna, vendedorId, estado, detalleEstado, , productos] = row;
            const statusClass = (estado || '').toLowerCase().replace(' ', '-');
            const brandColor = getColorFromString(marca);
            const formattedDate = formatDateInSpanish(fecha);

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-label="Marca">
                    <div style="display: flex; align-items: center; gap: 0.75rem; justify-content: center;">
                        <div class="logo-container" style="width: 32px; height: 32px; font-size: 0.9rem; background-color: ${brandColor}; flex-shrink: 0; margin: 0;">
                            ${marca ? marca.charAt(0) : ''}
                        </div>
                        <span style="font-weight: 500;">${marca}</span>
                    </div>
                </td>
                <td data-label="ID Venta" style="font-weight: 500;">${id}</td>
                <td data-label="Fecha">${formattedDate}<br><span style="font-size: 0.75rem; color: #9ca3af;">${hora}</span></td>
                <td data-label="Cliente">
                    <div class="client-info">
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            <span class="name">${getIcon('user')} ${nombre}</span>
                            <span>${getIcon('id_card')} ${rut}</span>
                            <span>${getIcon('phone')} ${tel}</span>
                            <span>${getIcon('location')} ${comuna}</span>
                        </div>
                    </div>
                </td>
                <td data-label="Vendedor"><div>${vendedorId}</div><div style="font-size: 0.75rem; color: #6b7280;">Call Center</div></td>
                <td data-label="Estado">
                    <div style="display: flex; flex-direction: column; gap: 0.25rem; align-items: center;">
                        <span class="status-badge ${statusClass}">${estado}</span>
                        <span style="font-size: 0.75rem; color: #6b7280;">${detalleEstado}</span>
                    </div>
                </td>
                <td data-label="Productos" style="font-weight: bold; font-size: 1.125rem;">${productos}</td>
                <td data-label="Acciones">
                    <button class="action-btn-table" title="Ver Detalle" onclick="window.openDetailsModal(${index})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    }
    
    // ===== CONFIGURACIÓN DE FILTROS =====
    function setupFilters() {
        // Filtro de Búsqueda
        document.getElementById('searchInput').addEventListener('input', applyFilters);

        // Filtro de Marcas (Custom Select)
        const brandContainer = document.getElementById('brandFilterContainer');
        const marcas = ['Todas las marcas', ...new Set(allSalesData.map(row => row[3]).filter(Boolean))];
        
        brandContainer.innerHTML = `
            <button id="brandFilterTrigger" class="custom-select-trigger">
                <span class="trigger-content">
                    <svg style="color: #9ca3af; width: 1.25rem; height: 1.25rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H3v16h18V4z"/><path d="M3 10h18"/><path d="M12 4v16"/></svg>
                    <span id="brandFilterValue">Todas las marcas</span>
                </span>
                <svg style="width: 1rem; height: 1rem; color: #9ca3af;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg>
            </button>
            <div id="brandFilterOptions" class="custom-select-options">
                ${marcas.map(m => `<div class="custom-select-option" data-value="${m === 'Todas las marcas' ? 'all' : m}">${m}</div>`).join('')}
            </div>
        `;
        
        const brandTrigger = document.getElementById('brandFilterTrigger');
        const brandOptions = document.getElementById('brandFilterOptions');
        
        brandTrigger.addEventListener('click', e => {
            e.stopPropagation();
            closeAllDropdowns();
            brandOptions.classList.toggle('is-open');
        });
        
        brandOptions.addEventListener('click', e => {
            if (e.target.classList.contains('custom-select-option')) {
                filtroMarcaActual = e.target.dataset.value;
                document.getElementById('brandFilterValue').textContent = e.target.textContent;
                brandOptions.classList.remove('is-open');
                applyFilters();
            }
        });

        // Filtros de Estado (Tabs)
        const estados = ['Listado', ...new Set(allSalesData.map(row => row[9]).filter(Boolean))];
        document.getElementById('navTabs').innerHTML = estados.map(e => `<div class="tab ${e === 'Listado' ? 'active' : ''}" data-filter="${e === 'Listado' ? '' : e}">${e}</div>`).join('');
        
        document.getElementById('navTabs').addEventListener('click', e => {
            if (e.target.classList.contains('tab')) {
                if(document.querySelector('.tab.active')) {
                    document.querySelector('.tab.active').classList.remove('active');
                }
                e.target.classList.add('active');
                filtroEstadoActual = e.target.dataset.filter;
                applyFilters();
            }
        });
    }
    
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        currentViewData = allSalesData.filter(row => {
            const rowText = row.join(' ').toLowerCase();
            const matchesSearch = rowText.includes(searchTerm);
            const matchesBrand = filtroMarcaActual === 'all' || row[3] === filtroMarcaActual;
            const matchesStatus = filtroEstadoActual === '' || row[9] === filtroEstadoActual;
            return matchesSearch && matchesBrand && matchesStatus;
        });
        renderTable(currentViewData);
    }
    
    // ===== GESTIÓN DE MODALES =====
    window.openDetailsModal = function(index) {
        const rowData = currentViewData[index];
        const [id, , , , rut, nombre, tel, comuna, vendedorId] = rowData;
        
        document.getElementById('modal-title').textContent = `Detalle Venta #${id}`;
        
        const imgUrl = `https://placehold.co/100x100/EFEFEF/333333?text=${vendedorId.charAt(0)}`;
        document.getElementById('modal-vendedor-img').src = imgUrl;
        
        document.getElementById('modal-vendedor-nombre').textContent = vendedorId;
        document.getElementById('modal-cliente-nombre').textContent = nombre;
        document.getElementById('modal-cliente-rut').textContent = rut;
        document.getElementById('modal-cliente-tel').textContent = tel;
        document.getElementById('modal-cliente-comuna').textContent = comuna;
        
        const modal = document.getElementById('detailsModal');
        modal.style.display = 'flex';
        modal.classList.add('is-open');
    }

    window.openIframeModal = function(url, title) {
        document.getElementById('iframe-modal-title').textContent = title;
        document.getElementById('modal-iframe-content').src = url;
        
        const modal = document.getElementById('iframeModal');
        modal.style.display = 'flex';
        modal.classList.add('is-open');
    }

    window.closeModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('is-open');
            modal.style.display = 'none';
        }
        
        if (modalId === 'iframeModal') {
             document.getElementById('modal-iframe-content').src = 'about:blank';
        }
    }
    
    // ===== MENÚS DESPLEGABLES =====
    function inicializarDropdowns() {
        createDropdown('commercialConditionsTrigger', 'commercialConditionsDropdown', opcionesMenuCondiciones);
        createDropdown('moreActionsTrigger', 'moreActionsDropdown', opcionesMenuMas);
    }

    function createDropdown(triggerId, menuId, options) {
        const trigger = document.getElementById(triggerId);
        const menu = document.getElementById(menuId);
        menu.innerHTML = options.map(opt => `<button class="action-dropdown-button" data-url="${opt.url}" data-title="${opt.nombre}">${opt.nombre}</button>`).join('');
        
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpening = !menu.classList.contains('is-open');
            closeAllDropdowns();
            if (isOpening) menu.classList.add('is-open');
        });
        
        menu.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                window.openIframeModal(e.target.dataset.url, e.target.dataset.title);
            }
        });
    }

    function closeAllDropdowns() {
        document.querySelectorAll('.action-dropdown-menu.is-open, .custom-select-options.is-open').forEach(menu => {
            menu.classList.remove('is-open');
        });
    }
    
    // ===== SISTEMA DE NOTIFICACIONES =====
    function inicializarNotificaciones() {
        cargarNotificaciones();
        document.getElementById('notificationsTrigger').addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('notificationsDropdown');
            const isOpening = !menu.classList.contains('is-open');
            closeAllDropdowns(); 
            if(isOpening) {
                menu.classList.add('is-open');
                document.getElementById('notification-badge').style.display = 'none';
            }
        });
    }

    async function cargarNotificaciones() {
        try {
            const res = await fetch(urlNotificaciones);
            const texto = await res.text();
            const json = parseGoogleSheetJSON(texto);

            allNotificationsData = json.table.rows.map(f => f.c.map(c => c ? c.v : ''));
            
            renderizarBandejaDeEntrada();
            revisarNotificacionesNuevas();

        } catch (error) {
            console.error("Error al cargar las notificaciones:", error);
            document.getElementById('notificationsDropdown').innerHTML = '<div class="notification-item"><p>Error al cargar notificaciones.</p></div>';
        }
    }

    function renderizarBandejaDeEntrada() {
        const container = document.getElementById('notificationsDropdown');
        container.innerHTML = '';
        if (allNotificationsData.length === 0) {
            container.innerHTML = '<div class="notification-item"><p>No hay mensajes.</p></div>';
            return;
        }

        allNotificationsData.forEach(notif => {
            const [id, mensaje, fecha, leido] = notif;
            const item = document.createElement('div');
            item.className = 'notification-item';
            if (String(leido).toUpperCase() === 'FALSE') {
                item.classList.add('unread');
            }
            item.innerHTML = `
                <p>${mensaje}</p>
                <span>${formatDateInSpanish(fecha)}</span>
            `;
            container.appendChild(item);
        });
    }

    function revisarNotificacionesNuevas() {
        const hayNuevas = allNotificationsData.some(notif => String(notif[3]).toUpperCase() === 'FALSE');
        document.getElementById('notification-badge').style.display = hayNuevas ? 'block' : 'none';
    }
    
    // ===== WIDGET DE CHAT =====
    function inicializarChat() {
        const fab = document.getElementById('fab');
        const chatWidget = document.getElementById('chat-widget');
        
        fab.addEventListener('click', () => chatWidget.classList.toggle('is-open'));
        document.getElementById('close-chat').addEventListener('click', () => chatWidget.classList.remove('is-open'));
        
        window.addEventListener('click', (e) => {
            if (!chatWidget.contains(e.target) && !fab.contains(e.target)) {
                chatWidget.classList.remove('is-open');
            }
            closeAllDropdowns();
        });

        document.getElementById('whatsapp-btn').addEventListener('click', () => {
            window.open('https://api.whatsapp.com/send?phone=TU_NUMERO_AQUI', '_blank');
        });
        
        document.getElementById('factibilidad-btn').addEventListener('click', () => {
            window.openIframeModal('https://es.wikipedia.org/wiki/Factibilidad', 'Factibilidad');
        });
        
        document.getElementById('assistant-btn').addEventListener('click', () => {
            window.openIframeModal('https://es.wikipedia.org/wiki/Asistente_virtual', 'Asistente');
        });
    }
    
    // ===== FUNCIONES AUXILIARES =====
    function parseGoogleSheetJSON(rawText) {
        const startIndex = rawText.indexOf('(');
        const endIndex = rawText.lastIndexOf(')');
        
        if (startIndex === -1 || endIndex === -1) {
            throw new Error("Respuesta JSON no válida de la API de Google Sheets.");
        }
        
        let jsonString = rawText.substring(startIndex + 1, endIndex);
        
        const jsonStart = jsonString.indexOf('{');
        const jsonEnd = jsonString.lastIndexOf('}');
        
        if (jsonStart === -1 || jsonEnd === -1) {
             throw new Error("No se encontró un objeto JSON válido en la respuesta.");
        }
        
        const cleanJsonString = jsonString.substring(jsonStart, jsonEnd + 1);
        return JSON.parse(cleanJsonString);
    }
    
    function exportToExcel() {
        const dataForExport = currentViewData.map(row => ({
            'ID Venta': row[0], 'Fecha': row[1], 'Hora': row[2], 'Marca': row[3], 'RUT': row[4],
            'Nombre Cliente': row[5], 'Teléfono': row[6], 'Comuna': row[7], 'Vendedor ID': row[8],
            'Estado': row[9], 'Detalle Estado': row[10], 'Fecha Estado': row[11], 'Productos': row[12]
        }));
        
        const ws = XLSX.utils.json_to_sheet(dataForExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ventas");
        XLSX.writeFile(wb, "ReporteVentas.xlsx");
    }

    function updateLastUpdatedTime() {
        const time = new Date().toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('last-updated').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg> <span style="vertical-align: middle;">Última actualización: Hoy, ${time}</span>`;
    }

    function getColorFromString(str) {
        if (!str) return '#6b7280';
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        let color = '#';
        for (let i = 0; i < 3; i++) {
            color += ('00' + ((hash >> (i * 8)) & 0xFF).toString(16)).substr(-2);
        }
        return color;
    }
    
    function formatDateInSpanish(dateString) {
        return dateString;
    }
    
    function getIcon(type) {
        const icons = {
            user: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#4b5563;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
            id_card: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#4b5563;"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="6" y1="12" x2="10" y2="12"></line></svg>`,
            phone: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#4b5563;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-7.01-7.01A19.79 19.79 0 0 1 2.05 4.11a2 2 0 0 1 1.72-2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>`,
            location: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#4b5563;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`
        };
        
        return icons[type] || '';
    }
</script>

</body>
</html>